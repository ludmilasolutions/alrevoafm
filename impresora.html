<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Xprinter 58 - QZ Tray</title>

<script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.2/qz-tray.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    max-width:700px;
    margin:40px auto;
}
h1{
    color:#2c3e50;
}
button{
    background:#007bff;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:6px;
    cursor:pointer;
    margin-top:10px;
}
button:disabled{
    background:#999;
}
select,input{
    width:100%;
    padding:8px;
    margin-top:8px;
}
.panel{
    background:white;
    padding:20px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    margin-top:20px;
}
.log{
    background:#eee;
    padding:10px;
    font-family:monospace;
    height:150px;
    overflow:auto;
}
.success{color:green;}
.error{color:red;}
</style>
</head>

<body>

<h1>üß™ Test Impresi√≥n Xprinter 58</h1>

<div class="panel">
    <button onclick="conectar()">üîå Conectar QZ</button>
    <select id="impresoras"></select>
    <input type="text" id="texto" value="PRUEBA DESDE POS AFMSOLUTIONS">
    <label><input type="checkbox" id="corte" checked> Corte de papel</label>
    <button onclick="imprimir()">üñ®Ô∏è Imprimir</button>
</div>

<div class="panel">
    <div id="estado"></div>
    <div class="log" id="log"></div>
</div>

<script>
let printerName = null;

function log(msg){
    const logDiv = document.getElementById("log");
    logDiv.innerHTML = new Date().toLocaleTimeString() + " - " + msg + "<br>" + logDiv.innerHTML;
}

async function conectar(){
    try{
        log("Conectando a QZ...");
        await qz.websocket.connect();

        const printers = await qz.printers.find();
        const select = document.getElementById("impresoras");
        select.innerHTML = "";

        printers.forEach(p=>{
            const option = document.createElement("option");
            option.value = p;
            option.textContent = p;
            select.appendChild(option);
        });

        log("Conectado. Impresoras encontradas: " + printers.length);
        document.getElementById("estado").innerHTML = "<span class='success'>Conectado a QZ</span>";

    }catch(err){
        log("Error conexi√≥n: " + err.message);
        document.getElementById("estado").innerHTML = "<span class='error'>Error conexi√≥n</span>";
    }
}

function construirESCPOSTicket(texto, incluirCorte){
    const bytes = [];

    // Inicializar
    bytes.push(0x1B, 0x40);

    // Texto centrado
    bytes.push(0x1B, 0x61, 0x01);

    for(let i=0;i<texto.length;i++){
        bytes.push(texto.charCodeAt(i) & 0xFF);
    }

    bytes.push(0x0A);
    bytes.push(0x0A);

    if(incluirCorte){
        bytes.push(0x1D, 0x56, 0x01);
    }

    // üî• Convertir bytes a string binario (clave para evitar error .search)
    return String.fromCharCode.apply(null, bytes);
}

async function imprimir(){
    try{
        const select = document.getElementById("impresoras");
        if(select.selectedIndex === -1){
            alert("Seleccion√° impresora");
            return;
        }

        printerName = select.value;

        const texto = document.getElementById("texto").value;
        const incluirCorte = document.getElementById("corte").checked;

        const config = qz.configs.create(printerName);

        const rawData = construirESCPOSTicket(texto, incluirCorte);

        const data = [{
            type: 'raw',
            format: 'command',
            data: rawData
        }];

        await qz.print(config, data);

        log("Impresi√≥n enviada correctamente");

    }catch(err){
        log("Error impresi√≥n: " + err.message);
        document.getElementById("estado").innerHTML = "<span class='error'>Error impresi√≥n</span>";
    }
}
</script>

</body>
</html>
