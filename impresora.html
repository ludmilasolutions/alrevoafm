<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diagn√≥stico Xprinter 58</title>

<script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.2/qz-tray.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;max-width:700px;margin:40px auto}
.panel{background:white;padding:20px;border-radius:8px;margin-top:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{padding:10px 15px;border:none;border-radius:5px;background:#007bff;color:white;margin:5px;cursor:pointer}
button:hover{background:#0056b3}
select,input{width:100%;padding:8px;margin-top:10px}
.log{background:#eee;padding:10px;height:180px;overflow:auto;font-family:monospace}
.success{color:green}
.error{color:red}
</style>
</head>

<body>

<h2>üß™ Diagn√≥stico Impresora Xprinter 58</h2>

<div class="panel">
    <button onclick="conectar()">üîå Conectar QZ</button>
    <select id="impresoras"></select>
</div>

<div class="panel">
    <input type="text" id="texto" value="PRUEBA XPRINTER 58">
    <button onclick="imprimirTexto()">üñ®Ô∏è Test 1 - Texto Plano</button>
    <button onclick="imprimirRaw()">üñ®Ô∏è Test 2 - ESC/POS Raw</button>
    <button onclick="abrirCaja()">üí∞ Test 3 - Pulso Caj√≥n</button>
</div>

<div class="panel">
    <div id="estado"></div>
    <div class="log" id="log"></div>
</div>

<script>

function log(msg){
    document.getElementById("log").innerHTML =
        new Date().toLocaleTimeString() + " - " + msg + "<br>" +
        document.getElementById("log").innerHTML;
}

async function conectar(){
    try{
        await qz.websocket.connect();
        const printers = await qz.printers.find();
        const select = document.getElementById("impresoras");
        select.innerHTML = "";

        printers.forEach(p=>{
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            select.appendChild(opt);
        });

        document.getElementById("estado").innerHTML =
            "<span class='success'>Conectado a QZ</span>";

        log("Impresoras encontradas: " + printers.length);

    }catch(e){
        document.getElementById("estado").innerHTML =
            "<span class='error'>Error conexi√≥n</span>";
        log("Error: " + e.message);
    }
}

function getConfig(){
    const printer = document.getElementById("impresoras").value;
    return qz.configs.create(printer, {
        encoding: "ISO-8859-1"
    });
}

async function imprimirTexto(){
    try{
        const config = getConfig();
        const texto = document.getElementById("texto").value + "\n\n\n";
        await qz.print(config, texto);
        log("Texto plano enviado");
    }catch(e){
        log("Error texto: " + e.message);
    }
}

async function imprimirRaw(){
    try{
        const config = getConfig();

        const bytes = [];

        // Inicializar impresora
        bytes.push(0x1B, 0x40);

        // Texto centrado
        bytes.push(0x1B, 0x61, 0x01);

        const texto = document.getElementById("texto").value;
        for(let i=0;i<texto.length;i++){
            bytes.push(texto.charCodeAt(i) & 0xFF);
        }

        bytes.push(0x0A);
        bytes.push(0x0A);

        // Corte papel
        bytes.push(0x1D, 0x56, 0x01);

        const rawString = String.fromCharCode.apply(null, bytes);

        const data = [{
            type: 'raw',
            format: 'command',
            data: rawString
        }];

        await qz.print(config, data);

        log("ESC/POS enviado correctamente");

    }catch(e){
        log("Error raw: " + e.message);
    }
}

async function abrirCaja(){
    try{
        const config = getConfig();

        const bytes = [
            0x1B, 0x70, 0x00, 0x19, 0xFA
        ];

        const rawString = String.fromCharCode.apply(null, bytes);

        const data = [{
            type: 'raw',
            format: 'command',
            data: rawString
        }];

        await qz.print(config, data);

        log("Pulso caj√≥n enviado");

    }catch(e){
        log("Error caj√≥n: " + e.message);
    }
}

</script>

</body>
</html>
